<div class="space-y-6" id="model-settings-container">
    <!-- 页面标题 -->
    <div class="flex items-center justify-between">
        <div>
            <h2 class="text-xl font-bold text-slate-800">模型设置</h2>
            <p class="text-sm text-slate-500 mt-1">配置模型 ID 映射并测试 API 接口，验证账号和模型是否正常工作</p>
        </div>
    </div>

    <!-- 模型 ID 映射 -->
    <div class="bg-white rounded-xl border border-slate-100 overflow-hidden">
        <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50 flex items-start justify-between gap-4">
            <div>
                <h3 class="font-semibold text-slate-800 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" class="text-violet-500">
                        <path d="M17 3L21 7l-4 4" />
                        <path d="M3 17l4 4 4-4" />
                        <path d="M21 7H7a4 4 0 0 0-4 4v0" />
                        <path d="M3 17h14a4 4 0 0 0 4-4v0" />
                    </svg>
                    模型 ID 映射
                </h3>
                <p class="text-xs text-slate-400 mt-1">
                    保存后 <code class="bg-slate-100 px-1 py-0.5 rounded">/v1/models</code> 将返回自定义模型ID；客户端使用该ID请求时会自动替换为原始模型ID。
                </p>
            </div>
            <div class="flex items-center gap-2">
                <button type="button" id="model-mapping-template-btn"
                    class="px-3 py-2 text-xs font-medium text-slate-700 bg-white border border-slate-200 rounded-lg hover:bg-slate-50 transition-colors whitespace-nowrap">
                    填入模板
                </button>
                <button type="button" id="model-mapping-save-btn"
                    class="px-3 py-2 text-xs font-medium text-white bg-violet-500 border border-violet-500 rounded-lg hover:bg-violet-600 transition-colors whitespace-nowrap flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" />
                        <polyline points="17 21 17 13 7 13 7 21" />
                        <polyline points="7 3 7 8 15 8" />
                    </svg>
                    <span>保存</span>
                </button>
            </div>
        </div>
        <div class="p-6 space-y-4">
            <!-- Tabs -->
            <div class="inline-flex rounded-lg bg-slate-100 p-1">
                <button type="button" id="model-mapping-tab-visual"
                    class="px-4 py-2 text-sm font-medium rounded-md bg-white text-slate-900 shadow-sm">
                    可视化
                </button>
                <button type="button" id="model-mapping-tab-manual"
                    class="px-4 py-2 text-sm font-medium rounded-md text-slate-600 hover:text-slate-800">
                    手动编辑
                </button>
            </div>

            <!-- Visual Panel -->
            <div id="model-mapping-visual-panel" class="space-y-3">
                <datalist id="original-model-id-datalist"></datalist>

                <div id="model-mapping-rows" class="space-y-3"></div>

                <div class="flex items-center justify-between gap-3">
                    <button type="button" id="model-mapping-add-row-btn"
                        class="px-4 py-2.5 text-sm font-medium text-blue-600 bg-blue-50 border border-blue-200 rounded-lg hover:bg-blue-100 transition-colors whitespace-nowrap flex items-center gap-2">
                        <span class="text-lg leading-none">+</span>
                        添加键值对
                    </button>
                    <div id="model-mapping-visual-status" class="text-xs text-slate-400"></div>
                </div>

                <p class="text-xs text-slate-400 pt-3 border-t border-slate-100">
                    键为客户端请求中的模型ID，值为要替换的原始模型ID（右侧支持下拉选择项目原始模型ID，也可手动输入）。
                </p>
            </div>

            <!-- Manual Panel -->
            <div id="model-mapping-manual-panel" class="hidden space-y-2">
                <textarea id="model-mapping-json-input" rows="10"
                    class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-violet-500/20 focus:border-violet-500 bg-white transition-all text-sm font-mono"
                    placeholder="{\n  \"自定义模型ID\": \"原始模型ID\"\n}"></textarea>
                <div class="flex items-center justify-between gap-3">
                    <div id="model-mapping-json-status" class="text-xs text-slate-400"></div>
                    <button type="button" id="model-mapping-format-btn"
                        class="px-3 py-2 text-xs font-medium text-slate-700 bg-white border border-slate-200 rounded-lg hover:bg-slate-50 transition-colors whitespace-nowrap">
                        格式化
                    </button>
                </div>
                <p class="text-xs text-slate-400">格式不正确将无法保存。</p>
            </div>
        </div>

        <script>
            (() => {
                const toast = (message, type) => {
                    document.body.dispatchEvent(new CustomEvent('showMessage', { detail: { message, type } }));
                };

                const tabVisualBtn = document.getElementById('model-mapping-tab-visual');
                const tabManualBtn = document.getElementById('model-mapping-tab-manual');
                const visualPanel = document.getElementById('model-mapping-visual-panel');
                const manualPanel = document.getElementById('model-mapping-manual-panel');
                const rowsEl = document.getElementById('model-mapping-rows');
                const addRowBtn = document.getElementById('model-mapping-add-row-btn');
                const saveBtn = document.getElementById('model-mapping-save-btn');
                const templateBtn = document.getElementById('model-mapping-template-btn');
                const formatBtn = document.getElementById('model-mapping-format-btn');
                const jsonInput = document.getElementById('model-mapping-json-input');
                const jsonStatus = document.getElementById('model-mapping-json-status');
                const visualStatus = document.getElementById('model-mapping-visual-status');
                const datalist = document.getElementById('original-model-id-datalist');

                if (!rowsEl || !saveBtn) return;

                let currentTab = 'visual';
                let mappingState = {}; // last valid mapping
                let manualValid = true;
                let visualValid = true;

                const normalizeId = (s) => {
                    const v = (s || '').trim();
                    return v.startsWith('models/') ? v.slice('models/'.length).trim() : v;
                };

                const setSaveEnabled = (enabled) => {
                    saveBtn.disabled = !enabled;
                    saveBtn.classList.toggle('opacity-50', !enabled);
                    saveBtn.classList.toggle('cursor-not-allowed', !enabled);
                };

                const setJsonStatus = (msg, type) => {
                    jsonStatus.textContent = msg || '';
                    jsonStatus.className = 'text-xs ' + (type === 'error' ? 'text-red-600' : type === 'success' ? 'text-emerald-600' : 'text-slate-400');
                };

                const setVisualStatus = (msg, type) => {
                    visualStatus.textContent = msg || '';
                    visualStatus.className = 'text-xs ' + (type === 'error' ? 'text-red-600' : type === 'success' ? 'text-emerald-600' : 'text-slate-400');
                };

                const validateMappingObject = (obj) => {
                    if (obj == null || typeof obj !== 'object' || Array.isArray(obj)) {
                        return { ok: false, error: 'JSON 必须是对象（例如：{"A":"B"}）' };
                    }

                    const out = {};
                    const usedValues = new Set();

                    for (const [k, v] of Object.entries(obj)) {
                        const key = normalizeId(k);
                        const value = normalizeId(typeof v === 'string' ? v : '');

                        if (!key) return { ok: false, error: '存在空的自定义模型ID（key）' };
                        if (!value) return { ok: false, error: `模型 "${key}" 的原始模型ID（value）不能为空` };
                        if (out[key] != null) return { ok: false, error: `自定义模型ID重复：\"${key}\"` };
                        if (usedValues.has(value)) return { ok: false, error: `原始模型ID被重复映射：\"${value}\"` };

                        usedValues.add(value);
                        out[key] = value;
                    }

                    return { ok: true, mapping: out };
                };

                const readVisualMapping = () => {
                    const rows = rowsEl.querySelectorAll('[data-model-mapping-row="1"]');
                    const out = {};
                    const usedValues = new Set();

                    for (const row of rows) {
                        const keyInput = row.querySelector('input[data-key="1"]');
                        const valueInput = row.querySelector('input[data-value="1"]');
                        const key = normalizeId(keyInput?.value || '');
                        const value = normalizeId(valueInput?.value || '');

                        if (!key && !value) continue; // ignore fully empty rows
                        if (!key) return { ok: false, error: '存在未填写的自定义模型ID（key）' };
                        if (!value) return { ok: false, error: `模型 \"${key}\" 的原始模型ID（value）不能为空` };
                        if (out[key] != null) return { ok: false, error: `自定义模型ID重复：\"${key}\"` };
                        if (usedValues.has(value)) return { ok: false, error: `原始模型ID被重复映射：\"${value}\"` };

                        usedValues.add(value);
                        out[key] = value;
                    }

                    return { ok: true, mapping: out };
                };

                const formatJson = (obj) => JSON.stringify(obj, null, 2);

                const updateSaveState = () => {
                    const enabled = currentTab === 'manual' ? manualValid : visualValid;
                    setSaveEnabled(enabled);
                };

                const syncManualFromState = () => {
                    if (!jsonInput) return;
                    jsonInput.value = formatJson(mappingState || {});
                    setJsonStatus('JSON 格式正确', 'success');
                    manualValid = true;
                };

                const renderRow = (key = '', value = '') => {
                    const row = document.createElement('div');
                    row.setAttribute('data-model-mapping-row', '1');
                    row.className = 'grid grid-cols-1 md:grid-cols-[1fr_1fr_auto] gap-2 items-stretch';

                    const keyInput = document.createElement('input');
                    keyInput.type = 'text';
                    keyInput.value = key;
                    keyInput.placeholder = '自定义模型ID（客户端使用）';
                    keyInput.className = 'w-full px-4 py-2.5 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-violet-500/20 focus:border-violet-500 bg-white transition-all text-sm font-mono';
                    keyInput.setAttribute('data-key', '1');

                    const valueInput = document.createElement('input');
                    valueInput.type = 'text';
                    valueInput.value = value;
                    valueInput.placeholder = '原始模型ID（项目提供）';
                    valueInput.className = 'w-full px-4 py-2.5 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-violet-500/20 focus:border-violet-500 bg-white transition-all text-sm font-mono';
                    valueInput.setAttribute('data-value', '1');
                    valueInput.setAttribute('list', 'original-model-id-datalist');

                    const delBtn = document.createElement('button');
                    delBtn.type = 'button';
                    delBtn.className = 'px-3 py-2.5 text-red-500 bg-red-50 border border-red-200 rounded-lg hover:bg-red-100 transition-colors flex items-center justify-center';
                    delBtn.setAttribute('aria-label', '删除');
                    delBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M8 6V4h8v2"/><path d="M19 6l-1 14H6L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/></svg>';

                    const onChange = () => {
                        const res = readVisualMapping();
                        if (!res.ok) {
                            visualValid = false;
                            setVisualStatus(res.error, 'error');
                        } else {
                            visualValid = true;
                            mappingState = res.mapping;
                            setVisualStatus(`共 ${Object.keys(mappingState).length} 条映射`, 'success');
                            // 在可视化编辑时保持手动编辑内容同步（不会影响手动编辑时的输入）。
                            if (currentTab === 'visual') {
                                syncManualFromState();
                            }
                        }
                        updateSaveState();
                    };

                    keyInput.addEventListener('input', onChange);
                    valueInput.addEventListener('input', onChange);
                    delBtn.addEventListener('click', () => {
                        row.remove();
                        onChange();
                    });

                    row.appendChild(keyInput);
                    row.appendChild(valueInput);
                    row.appendChild(delBtn);
                    return row;
                };

                const renderVisualFromState = () => {
                    rowsEl.innerHTML = '';
                    const entries = Object.entries(mappingState || {});
                    if (entries.length === 0) {
                        rowsEl.appendChild(renderRow('', ''));
                        setVisualStatus('未配置映射', 'info');
                        return;
                    }
                    entries.forEach(([k, v]) => rowsEl.appendChild(renderRow(k, v)));
                    setVisualStatus(`共 ${entries.length} 条映射`, 'success');
                };

                const setTab = (tab) => {
                    if (tab === currentTab) return;
                    // 若 JSON 无效，禁止从手动编辑切换到可视化（避免丢失上下文）。
                    if (currentTab === 'manual' && !manualValid && tab === 'visual') {
                        toast('JSON 格式不正确，无法切换到可视化', 'error');
                        return;
                    }
                    currentTab = tab;
                    if (tab === 'visual') {
                        tabVisualBtn.className = 'px-4 py-2 text-sm font-medium rounded-md bg-white text-slate-900 shadow-sm';
                        tabManualBtn.className = 'px-4 py-2 text-sm font-medium rounded-md text-slate-600 hover:text-slate-800';
                        manualPanel.classList.add('hidden');
                        visualPanel.classList.remove('hidden');
                        renderVisualFromState();
                        const res = readVisualMapping();
                        visualValid = res.ok;
                        if (!res.ok) setVisualStatus(res.error, 'error');
                    } else {
                        tabManualBtn.className = 'px-4 py-2 text-sm font-medium rounded-md bg-white text-slate-900 shadow-sm';
                        tabVisualBtn.className = 'px-4 py-2 text-sm font-medium rounded-md text-slate-600 hover:text-slate-800';
                        visualPanel.classList.add('hidden');
                        manualPanel.classList.remove('hidden');
                        syncManualFromState();
                    }
                    updateSaveState();
                };

                tabVisualBtn?.addEventListener('click', () => setTab('visual'));
                tabManualBtn?.addEventListener('click', () => setTab('manual'));

                addRowBtn?.addEventListener('click', () => {
                    rowsEl.appendChild(renderRow('', ''));
                    const res = readVisualMapping();
                    visualValid = res.ok;
                    if (!res.ok) setVisualStatus(res.error, 'error');
                    updateSaveState();
                });

                const onManualInput = () => {
                    const text = (jsonInput?.value || '').trim();
                    if (!text) {
                        mappingState = {};
                        manualValid = true;
                        setJsonStatus('空值将视为 {}', 'info');
                        updateSaveState();
                        return;
                    }

                    let parsed;
                    try {
                        parsed = JSON.parse(text);
                    } catch (e) {
                        manualValid = false;
                        setJsonStatus('JSON 格式错误：' + (e?.message || '无法解析'), 'error');
                        updateSaveState();
                        return;
                    }

                    const res = validateMappingObject(parsed);
                    if (!res.ok) {
                        manualValid = false;
                        setJsonStatus(res.error, 'error');
                        updateSaveState();
                        return;
                    }

                    mappingState = res.mapping;
                    manualValid = true;
                    setJsonStatus('JSON 格式正确', 'success');
                    updateSaveState();
                };

                jsonInput?.addEventListener('input', onManualInput);

                formatBtn?.addEventListener('click', () => {
                    if (!manualValid) return;
                    jsonInput.value = formatJson(mappingState || {});
                    setJsonStatus('已格式化', 'success');
                });

                const refreshOriginalModels = async () => {
                    try {
                        const resp = await fetch('/v1/models?raw=true', { credentials: 'same-origin' });
                        const data = await resp.json().catch(() => ({}));
                        const list = (data?.data || []).map(m => m?.id).filter(Boolean);

                        datalist.innerHTML = '';
                        list.forEach(id => {
                            const opt = document.createElement('option');
                            opt.value = id;
                            datalist.appendChild(opt);
                        });

                        if (list.length > 0) {
                            setVisualStatus(`已加载 ${list.length} 个原始模型ID`, 'info');
                        }
                    } catch (e) {
                        // 不阻塞：允许手动输入 value
                    }
                };

                templateBtn?.addEventListener('click', async () => {
                    try {
                        const resp = await fetch('/v1/models?raw=true', { credentials: 'same-origin' });
                        const data = await resp.json().catch(() => ({}));
                        const list = (data?.data || []).map(m => m?.id).filter(Boolean);
                        if (list.length === 0) throw new Error('模型列表为空');

                        const tpl = {};
                        list.forEach(id => {
                            const k = normalizeId(id);
                            tpl[k] = normalizeId(id);
                        });

                        mappingState = tpl;
                        if (currentTab === 'manual') {
                            syncManualFromState();
                        } else {
                            renderVisualFromState();
                            const res = readVisualMapping();
                            visualValid = res.ok;
                            if (!res.ok) setVisualStatus(res.error, 'error');
                            updateSaveState();
                        }
                        toast('已填入模板', 'success');
                    } catch (e) {
                        toast(e?.message || '填入模板失败', 'error');
                    }
                });

                saveBtn?.addEventListener('click', async () => {
                    let toSave = null;

                    if (currentTab === 'manual') {
                        onManualInput();
                        if (!manualValid) return;
                        toSave = mappingState || {};
                    } else {
                        const res = readVisualMapping();
                        if (!res.ok) {
                            toast(res.error || '映射格式不正确', 'error');
                            return;
                        }
                        mappingState = res.mapping;
                        toSave = mappingState || {};
                    }

                    saveBtn.disabled = true;
                    const oldHtml = saveBtn.innerHTML;
                    saveBtn.innerHTML = '<svg class="animate-spin" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg><span>保存中...</span>';

                    try {
                        const resp = await fetch('/manager/api/model-id-mapping', {
                            method: 'POST',
                            credentials: 'same-origin',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(toSave)
                        });
                        const data = await resp.json().catch(() => ({}));
                        if (!resp.ok || !data?.success) {
                            throw new Error(data?.error || '保存失败');
                        }
                        toast('模型 ID 映射已保存并生效', 'success');
                    } catch (e) {
                        toast(e?.message || '保存失败', 'error');
                    } finally {
                        saveBtn.disabled = false;
                        saveBtn.innerHTML = oldHtml;
                        updateSaveState();
                    }
                });

                const init = async () => {
                    // 1) 加载当前映射
                    try {
                        const resp = await fetch('/manager/api/model-id-mapping', { credentials: 'same-origin' });
                        const data = await resp.json().catch(() => ({}));
                        if (resp.ok) {
                            const res = validateMappingObject(data || {});
                            if (res.ok) mappingState = res.mapping;
                        }
                    } catch (e) {
                        // ignore
                    }

                    // 2) 拉取原始模型ID列表，用于下拉建议
                    await refreshOriginalModels();

                    // 3) 渲染
                    renderVisualFromState();
                    syncManualFromState();

                    // 4) 初始校验
                    const res = readVisualMapping();
                    visualValid = res.ok;
                    if (!res.ok) setVisualStatus(res.error, 'error');
                    onManualInput();
                    updateSaveState();
                };

                init();
            })();
        </script>
    </div>

    <!-- 测试表单 -->
    <div class="bg-white rounded-xl border border-slate-100 overflow-hidden">
        <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50">
            <h3 class="font-semibold text-slate-800 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" class="text-blue-500">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
                </svg>
                聊天测试
            </h3>
        </div>
        <div class="p-6 space-y-5">
            <!-- 账号选择 -->
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1.5">
                    选择账号
                    <span class="text-red-500 ml-0.5">*</span>
                </label>
                <select id="test-account-select"
                    class="w-full px-4 py-2.5 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 bg-white transition-all text-sm max-h-40 overflow-y-auto">
                    <option value="">-- 请选择账号 --</option>
                    {% for account in accounts %}
                    <option value="{{ account.session_id }}">{{ account.display_name }}</option>
                    {% endfor %}
                </select>
                {% if accounts.is_empty() %}
                <p class="mt-1.5 text-xs text-amber-600">暂无可用账号，请先在"账号管理"中添加账号</p>
                {% else %}
                <p class="mt-1.5 text-xs text-slate-400">共 {{ accounts.len() }} 个可用账号</p>
                {% endif %}
            </div>

            <!-- 模型选择 -->
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1.5">
                    选择模型
                    <span class="text-red-500 ml-0.5">*</span>
                </label>
                <div class="flex gap-2">
                    <select id="test-model-select"
                        class="flex-1 px-4 py-2.5 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 bg-white transition-all text-sm">
                        <option value="">-- 请先获取模型列表 --</option>
                    </select>
                    <button type="button" id="fetch-models-btn"
                        class="px-4 py-2.5 text-sm font-medium text-blue-600 bg-blue-50 border border-blue-200 rounded-lg hover:bg-blue-100 transition-colors whitespace-nowrap">
                        获取模型
                    </button>
                </div>
                <p class="mt-1.5 text-xs text-slate-400">点击"获取模型"从 API 加载可用模型列表</p>
            </div>

            <!-- 接口选择 -->
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1.5">
                    API 接口
                </label>
                <div class="flex gap-3">
                    <label class="flex-1 relative cursor-pointer">
                        <input type="radio" name="testProvider" value="openai" class="peer sr-only" checked />
                        <div
                            class="px-4 py-3 rounded-lg border border-slate-200 text-center transition-all peer-checked:border-blue-500 peer-checked:bg-blue-50 peer-checked:text-blue-700 hover:border-slate-300">
                            <div class="font-medium text-sm">OpenAI</div>
                            <div class="text-xs text-slate-400 mt-0.5">/v1/chat/completions</div>
                        </div>
                    </label>
                    <label class="flex-1 relative cursor-pointer">
                        <input type="radio" name="testProvider" value="claude" class="peer sr-only" />
                        <div
                            class="px-4 py-3 rounded-lg border border-slate-200 text-center transition-all peer-checked:border-blue-500 peer-checked:bg-blue-50 peer-checked:text-blue-700 hover:border-slate-300">
                            <div class="font-medium text-sm">Claude</div>
                            <div class="text-xs text-slate-400 mt-0.5">/v1/messages</div>
                        </div>
                    </label>
                </div>
            </div>

            <!-- 提示词输入 -->
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1.5">
                    测试提示词
                </label>
                <textarea id="test-prompt-input" rows="3"
                    class="w-full px-4 py-2.5 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 bg-white transition-all text-sm resize-none"
                    placeholder="输入测试提示词，例如：你好，请简单介绍一下自己">你好，请用一句话介绍你自己。</textarea>
            </div>

            <!-- 操作按钮 -->
            <div class="flex items-center gap-3">
                <button type="button" id="start-test-btn"
                    class="px-6 py-2.5 text-sm font-medium text-white bg-emerald-500 rounded-lg hover:bg-emerald-600 transition-colors flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2">
                        <polygon points="5 3 19 12 5 21 5 3" />
                    </svg>
                    <span>开始测试</span>
                </button>
                <button type="button" id="stop-test-btn"
                    class="px-6 py-2.5 text-sm font-medium text-white bg-red-500 rounded-lg hover:bg-red-600 transition-colors flex items-center gap-2 hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2">
                        <rect x="6" y="6" width="12" height="12" />
                    </svg>
                    <span>停止</span>
                </button>
                <span id="test-status" class="text-sm text-slate-500"></span>
            </div>
        </div>
    </div>

    <!-- 输出区域 -->
    <div class="bg-white rounded-xl border border-slate-100 overflow-hidden">
        <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50 flex items-center justify-between">
            <h3 class="font-semibold text-slate-800 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" class="text-emerald-500">
                    <polyline points="4 17 10 11 4 5" />
                    <line x1="12" x2="20" y1="19" y2="19" />
                </svg>
                输出结果
            </h3>
            <button type="button" id="clear-output-btn"
                class="px-3 py-1.5 text-xs font-medium text-slate-600 bg-slate-100 rounded hover:bg-slate-200 transition-colors">
                清空
            </button>
        </div>
        <div class="p-6">
            <div id="test-output"
                class="min-h-[200px] max-h-[400px] overflow-y-auto p-4 bg-slate-50 rounded-lg border border-slate-200 font-mono text-sm text-slate-700 whitespace-pre-wrap">
                <span class="text-slate-400">等待测试...</span>
            </div>
        </div>
    </div>

    <script>
        (() => {
            const accountSelect = document.getElementById('test-account-select');
            const modelSelect = document.getElementById('test-model-select');
            const fetchModelsBtn = document.getElementById('fetch-models-btn');
            const promptInput = document.getElementById('test-prompt-input');
            const startBtn = document.getElementById('start-test-btn');
            const stopBtn = document.getElementById('stop-test-btn');
            const statusEl = document.getElementById('test-status');
            const outputEl = document.getElementById('test-output');
            const clearBtn = document.getElementById('clear-output-btn');

            let currentController = null; // 用于取消请求

            const toast = (message, type) => {
                document.body.dispatchEvent(new CustomEvent('showMessage', { detail: { message, type } }));
            };

            const setStatus = (msg, type) => {
                statusEl.textContent = msg || '';
                statusEl.className = 'text-sm ' + (type === 'error' ? 'text-red-600' : type === 'success' ? 'text-emerald-600' : 'text-slate-500');
            };

            const setOutput = (content, append = false) => {
                if (append) {
                    // 移除"等待测试..."占位符
                    if (outputEl.querySelector('.text-slate-400')) {
                        outputEl.innerHTML = '';
                    }
                    outputEl.textContent += content;
                } else {
                    outputEl.innerHTML = content ? `<span>${content}</span>` : '<span class="text-slate-400">等待测试...</span>';
                }
                // 自动滚动到底部
                outputEl.scrollTop = outputEl.scrollHeight;
            };

            const setLoading = (loading) => {
                if (loading) {
                    startBtn.classList.add('hidden');
                    stopBtn.classList.remove('hidden');
                    accountSelect.disabled = true;
                    modelSelect.disabled = true;
                    fetchModelsBtn.disabled = true;
                    promptInput.disabled = true;
                } else {
                    startBtn.classList.remove('hidden');
                    stopBtn.classList.add('hidden');
                    accountSelect.disabled = false;
                    modelSelect.disabled = false;
                    fetchModelsBtn.disabled = false;
                    promptInput.disabled = false;
                }
            };

            // 获取模型列表
            fetchModelsBtn?.addEventListener('click', async () => {
                fetchModelsBtn.disabled = true;
                fetchModelsBtn.textContent = '获取中...';
                setStatus('正在获取模型列表...', 'info');

                try {
                    const resp = await fetch('/v1/models', { credentials: 'same-origin' });
                    const data = await resp.json().catch(() => ({}));

                    if (!resp.ok) {
                        throw new Error(data?.error?.message || '获取模型列表失败');
                    }

                    const models = data?.data || [];
                    if (models.length === 0) {
                        throw new Error('模型列表为空');
                    }

                    // 填充下拉框
                    modelSelect.innerHTML = '<option value="">-- 请选择模型 --</option>';
                    models.forEach(m => {
                        const opt = document.createElement('option');
                        opt.value = m.id;
                        opt.textContent = m.id;
                        modelSelect.appendChild(opt);
                    });

                    setStatus(`已加载 ${models.length} 个模型`, 'success');
                    toast(`已加载 ${models.length} 个模型`, 'success');
                } catch (e) {
                    setStatus(e?.message || '获取模型列表失败', 'error');
                    toast(e?.message || '获取模型列表失败', 'error');
                } finally {
                    fetchModelsBtn.disabled = false;
                    fetchModelsBtn.textContent = '获取模型';
                }
            });

            // 开始测试
            startBtn?.addEventListener('click', async () => {
                const sessionId = accountSelect?.value?.trim();
                const model = modelSelect?.value?.trim();
                const prompt = promptInput?.value?.trim();
                const providerRadio = document.querySelector('input[name="testProvider"]:checked');
                const provider = providerRadio?.value || 'openai';

                if (!sessionId) {
                    toast('请选择账号', 'error');
                    return;
                }
                if (!model) {
                    toast('请选择模型', 'error');
                    return;
                }
                if (!prompt) {
                    toast('请输入测试提示词', 'error');
                    return;
                }

                setLoading(true);
                setOutput('');
                setStatus('正在连接...', 'info');

                currentController = new AbortController();

                try {
                    const resp = await fetch('/manager/api/chat/test', {
                        method: 'POST',
                        credentials: 'same-origin',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ sessionId, model, provider, prompt }),
                        signal: currentController.signal
                    });

                    if (!resp.ok) {
                        const errData = await resp.json().catch(() => ({}));
                        throw new Error(errData?.error || `HTTP ${resp.status}`);
                    }

                    setStatus('正在接收响应...', 'info');

                    // 处理 SSE 流
                    const reader = resp.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';
                    let hasContent = false;
                    let hasError = false;

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n');
                        buffer = lines.pop() || '';

                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const data = line.slice(6);
                                if (data === '[DONE]') {
                                    continue;
                                }
                                try {
                                    const parsed = JSON.parse(data);
                                    // OpenAI 格式
                                    if (parsed.choices?.[0]?.delta?.content) {
                                        setOutput(parsed.choices[0].delta.content, true);
                                        hasContent = true;
                                    }
                                    // Claude 格式
                                    if (parsed.type === 'content_block_delta' && parsed.delta?.text) {
                                        setOutput(parsed.delta.text, true);
                                        hasContent = true;
                                    }
                                    // 错误
                                    if (parsed.error) {
                                        setOutput(`\n\n[错误] ${parsed.error.message || JSON.stringify(parsed.error)}`, true);
                                        hasError = true;
                                    }
                                } catch (e) {
                                    // 忽略解析错误
                                }
                            }
                        }
                    }

                    if (hasError) {
                        setStatus('测试失败', 'error');
                        toast('测试失败', 'error');
                    } else if (hasContent) {
                        setStatus('测试成功', 'success');
                        toast('测试成功', 'success');
                    } else {
                        setStatus('未收到有效响应', 'error');
                        toast('未收到有效响应', 'error');
                    }
                } catch (e) {
                    if (e.name === 'AbortError') {
                        setStatus('已取消', 'info');
                        setOutput('\n\n[已取消]', true);
                    } else {
                        setStatus(e?.message || '测试失败', 'error');
                        setOutput(`\n\n[错误] ${e?.message || '未知错误'}`, true);
                        toast(e?.message || '测试失败', 'error');
                    }
                } finally {
                    setLoading(false);
                    currentController = null;
                }
            });

            // 停止测试
            stopBtn?.addEventListener('click', () => {
                if (currentController) {
                    currentController.abort();
                    currentController = null;
                }
            });

            // 清空输出
            clearBtn?.addEventListener('click', () => {
                setOutput('');
                setStatus('', '');
            });
        })();
    </script>
</div>
