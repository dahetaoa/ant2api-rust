<div class="space-y-6" id="model-settings-container">
    <!-- 页面标题 -->
    <div class="flex items-center justify-between">
        <div>
            <h2 class="text-xl font-bold text-slate-800">模型设置</h2>
            <p class="text-sm text-slate-500 mt-1">测试 API 接口，验证账号和模型是否正常工作</p>
        </div>
    </div>

    <!-- 测试表单 -->
    <div class="bg-white rounded-xl border border-slate-100 overflow-hidden">
        <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50">
            <h3 class="font-semibold text-slate-800 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" class="text-blue-500">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
                </svg>
                聊天测试
            </h3>
        </div>
        <div class="p-6 space-y-5">
            <!-- 账号选择 -->
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1.5">
                    选择账号
                    <span class="text-red-500 ml-0.5">*</span>
                </label>
                <select id="test-account-select"
                    class="w-full px-4 py-2.5 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 bg-white transition-all text-sm max-h-40 overflow-y-auto">
                    <option value="">-- 请选择账号 --</option>
                    {% for account in accounts %}
                    <option value="{{ account.session_id }}">{{ account.display_name }}</option>
                    {% endfor %}
                </select>
                {% if accounts.is_empty() %}
                <p class="mt-1.5 text-xs text-amber-600">暂无可用账号，请先在"账号管理"中添加账号</p>
                {% else %}
                <p class="mt-1.5 text-xs text-slate-400">共 {{ accounts.len() }} 个可用账号</p>
                {% endif %}
            </div>

            <!-- 模型选择 -->
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1.5">
                    选择模型
                    <span class="text-red-500 ml-0.5">*</span>
                </label>
                <div class="flex gap-2">
                    <select id="test-model-select"
                        class="flex-1 px-4 py-2.5 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 bg-white transition-all text-sm">
                        <option value="">-- 请先获取模型列表 --</option>
                    </select>
                    <button type="button" id="fetch-models-btn"
                        class="px-4 py-2.5 text-sm font-medium text-blue-600 bg-blue-50 border border-blue-200 rounded-lg hover:bg-blue-100 transition-colors whitespace-nowrap">
                        获取模型
                    </button>
                </div>
                <p class="mt-1.5 text-xs text-slate-400">点击"获取模型"从 API 加载可用模型列表</p>
            </div>

            <!-- 接口选择 -->
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1.5">
                    API 接口
                </label>
                <div class="flex gap-3">
                    <label class="flex-1 relative cursor-pointer">
                        <input type="radio" name="testProvider" value="openai" class="peer sr-only" checked />
                        <div
                            class="px-4 py-3 rounded-lg border border-slate-200 text-center transition-all peer-checked:border-blue-500 peer-checked:bg-blue-50 peer-checked:text-blue-700 hover:border-slate-300">
                            <div class="font-medium text-sm">OpenAI</div>
                            <div class="text-xs text-slate-400 mt-0.5">/v1/chat/completions</div>
                        </div>
                    </label>
                    <label class="flex-1 relative cursor-pointer">
                        <input type="radio" name="testProvider" value="claude" class="peer sr-only" />
                        <div
                            class="px-4 py-3 rounded-lg border border-slate-200 text-center transition-all peer-checked:border-blue-500 peer-checked:bg-blue-50 peer-checked:text-blue-700 hover:border-slate-300">
                            <div class="font-medium text-sm">Claude</div>
                            <div class="text-xs text-slate-400 mt-0.5">/v1/messages</div>
                        </div>
                    </label>
                </div>
            </div>

            <!-- 提示词输入 -->
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1.5">
                    测试提示词
                </label>
                <textarea id="test-prompt-input" rows="3"
                    class="w-full px-4 py-2.5 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 bg-white transition-all text-sm resize-none"
                    placeholder="输入测试提示词，例如：你好，请简单介绍一下自己">你好，请用一句话介绍你自己。</textarea>
            </div>

            <!-- 操作按钮 -->
            <div class="flex items-center gap-3">
                <button type="button" id="start-test-btn"
                    class="px-6 py-2.5 text-sm font-medium text-white bg-emerald-500 rounded-lg hover:bg-emerald-600 transition-colors flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2">
                        <polygon points="5 3 19 12 5 21 5 3" />
                    </svg>
                    <span>开始测试</span>
                </button>
                <button type="button" id="stop-test-btn"
                    class="px-6 py-2.5 text-sm font-medium text-white bg-red-500 rounded-lg hover:bg-red-600 transition-colors flex items-center gap-2 hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2">
                        <rect x="6" y="6" width="12" height="12" />
                    </svg>
                    <span>停止</span>
                </button>
                <span id="test-status" class="text-sm text-slate-500"></span>
            </div>
        </div>
    </div>

    <!-- 输出区域 -->
    <div class="bg-white rounded-xl border border-slate-100 overflow-hidden">
        <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50 flex items-center justify-between">
            <h3 class="font-semibold text-slate-800 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" class="text-emerald-500">
                    <polyline points="4 17 10 11 4 5" />
                    <line x1="12" x2="20" y1="19" y2="19" />
                </svg>
                输出结果
            </h3>
            <button type="button" id="clear-output-btn"
                class="px-3 py-1.5 text-xs font-medium text-slate-600 bg-slate-100 rounded hover:bg-slate-200 transition-colors">
                清空
            </button>
        </div>
        <div class="p-6">
            <div id="test-output"
                class="min-h-[200px] max-h-[400px] overflow-y-auto p-4 bg-slate-50 rounded-lg border border-slate-200 font-mono text-sm text-slate-700 whitespace-pre-wrap">
                <span class="text-slate-400">等待测试...</span>
            </div>
        </div>
    </div>

    <script>
        (() => {
            const accountSelect = document.getElementById('test-account-select');
            const modelSelect = document.getElementById('test-model-select');
            const fetchModelsBtn = document.getElementById('fetch-models-btn');
            const promptInput = document.getElementById('test-prompt-input');
            const startBtn = document.getElementById('start-test-btn');
            const stopBtn = document.getElementById('stop-test-btn');
            const statusEl = document.getElementById('test-status');
            const outputEl = document.getElementById('test-output');
            const clearBtn = document.getElementById('clear-output-btn');

            let currentController = null; // 用于取消请求

            const toast = (message, type) => {
                document.body.dispatchEvent(new CustomEvent('showMessage', { detail: { message, type } }));
            };

            const setStatus = (msg, type) => {
                statusEl.textContent = msg || '';
                statusEl.className = 'text-sm ' + (type === 'error' ? 'text-red-600' : type === 'success' ? 'text-emerald-600' : 'text-slate-500');
            };

            const setOutput = (content, append = false) => {
                if (append) {
                    // 移除"等待测试..."占位符
                    if (outputEl.querySelector('.text-slate-400')) {
                        outputEl.innerHTML = '';
                    }
                    outputEl.textContent += content;
                } else {
                    outputEl.innerHTML = content ? `<span>${content}</span>` : '<span class="text-slate-400">等待测试...</span>';
                }
                // 自动滚动到底部
                outputEl.scrollTop = outputEl.scrollHeight;
            };

            const setLoading = (loading) => {
                if (loading) {
                    startBtn.classList.add('hidden');
                    stopBtn.classList.remove('hidden');
                    accountSelect.disabled = true;
                    modelSelect.disabled = true;
                    fetchModelsBtn.disabled = true;
                    promptInput.disabled = true;
                } else {
                    startBtn.classList.remove('hidden');
                    stopBtn.classList.add('hidden');
                    accountSelect.disabled = false;
                    modelSelect.disabled = false;
                    fetchModelsBtn.disabled = false;
                    promptInput.disabled = false;
                }
            };

            // 获取模型列表
            fetchModelsBtn?.addEventListener('click', async () => {
                fetchModelsBtn.disabled = true;
                fetchModelsBtn.textContent = '获取中...';
                setStatus('正在获取模型列表...', 'info');

                try {
                    const resp = await fetch('/v1/models', { credentials: 'same-origin' });
                    const data = await resp.json().catch(() => ({}));

                    if (!resp.ok) {
                        throw new Error(data?.error?.message || '获取模型列表失败');
                    }

                    const models = data?.data || [];
                    if (models.length === 0) {
                        throw new Error('模型列表为空');
                    }

                    // 填充下拉框
                    modelSelect.innerHTML = '<option value="">-- 请选择模型 --</option>';
                    models.forEach(m => {
                        const opt = document.createElement('option');
                        opt.value = m.id;
                        opt.textContent = m.id;
                        modelSelect.appendChild(opt);
                    });

                    setStatus(`已加载 ${models.length} 个模型`, 'success');
                    toast(`已加载 ${models.length} 个模型`, 'success');
                } catch (e) {
                    setStatus(e?.message || '获取模型列表失败', 'error');
                    toast(e?.message || '获取模型列表失败', 'error');
                } finally {
                    fetchModelsBtn.disabled = false;
                    fetchModelsBtn.textContent = '获取模型';
                }
            });

            // 开始测试
            startBtn?.addEventListener('click', async () => {
                const sessionId = accountSelect?.value?.trim();
                const model = modelSelect?.value?.trim();
                const prompt = promptInput?.value?.trim();
                const providerRadio = document.querySelector('input[name="testProvider"]:checked');
                const provider = providerRadio?.value || 'openai';

                if (!sessionId) {
                    toast('请选择账号', 'error');
                    return;
                }
                if (!model) {
                    toast('请选择模型', 'error');
                    return;
                }
                if (!prompt) {
                    toast('请输入测试提示词', 'error');
                    return;
                }

                setLoading(true);
                setOutput('');
                setStatus('正在连接...', 'info');

                currentController = new AbortController();

                try {
                    const resp = await fetch('/manager/api/chat/test', {
                        method: 'POST',
                        credentials: 'same-origin',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ sessionId, model, provider, prompt }),
                        signal: currentController.signal
                    });

                    if (!resp.ok) {
                        const errData = await resp.json().catch(() => ({}));
                        throw new Error(errData?.error || `HTTP ${resp.status}`);
                    }

                    setStatus('正在接收响应...', 'info');

                    // 处理 SSE 流
                    const reader = resp.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';
                    let hasContent = false;
                    let hasError = false;

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n');
                        buffer = lines.pop() || '';

                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const data = line.slice(6);
                                if (data === '[DONE]') {
                                    continue;
                                }
                                try {
                                    const parsed = JSON.parse(data);
                                    // OpenAI 格式
                                    if (parsed.choices?.[0]?.delta?.content) {
                                        setOutput(parsed.choices[0].delta.content, true);
                                        hasContent = true;
                                    }
                                    // Claude 格式
                                    if (parsed.type === 'content_block_delta' && parsed.delta?.text) {
                                        setOutput(parsed.delta.text, true);
                                        hasContent = true;
                                    }
                                    // 错误
                                    if (parsed.error) {
                                        setOutput(`\n\n[错误] ${parsed.error.message || JSON.stringify(parsed.error)}`, true);
                                        hasError = true;
                                    }
                                } catch (e) {
                                    // 忽略解析错误
                                }
                            }
                        }
                    }

                    if (hasError) {
                        setStatus('测试失败', 'error');
                        toast('测试失败', 'error');
                    } else if (hasContent) {
                        setStatus('测试成功', 'success');
                        toast('测试成功', 'success');
                    } else {
                        setStatus('未收到有效响应', 'error');
                        toast('未收到有效响应', 'error');
                    }
                } catch (e) {
                    if (e.name === 'AbortError') {
                        setStatus('已取消', 'info');
                        setOutput('\n\n[已取消]', true);
                    } else {
                        setStatus(e?.message || '测试失败', 'error');
                        setOutput(`\n\n[错误] ${e?.message || '未知错误'}`, true);
                        toast(e?.message || '测试失败', 'error');
                    }
                } finally {
                    setLoading(false);
                    currentController = null;
                }
            });

            // 停止测试
            stopBtn?.addEventListener('click', () => {
                if (currentController) {
                    currentController.abort();
                    currentController = null;
                }
            });

            // 清空输出
            clearBtn?.addEventListener('click', () => {
                setOutput('');
                setStatus('', '');
            });
        })();
    </script>
</div>
