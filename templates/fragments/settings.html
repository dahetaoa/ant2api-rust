<div class="space-y-6" id="settings-container">
    <!-- Page Header -->
    <div class="flex items-center justify-between">
        <div>
            <h2 class="text-xl font-bold text-slate-800">系统设置</h2>
            <p class="text-sm text-slate-500 mt-1">配置 API 密钥、登录密码等全局参数，修改后立即生效</p>
        </div>
    </div>

    <!-- Settings Form -->
    <form id="settings-form" class="space-y-6">
        <!-- Authentication Settings -->
        <div class="bg-white rounded-xl border border-slate-100 overflow-hidden">
            <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50">
                <h3 class="font-semibold text-slate-800 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" class="text-blue-500">
                        <rect width="18" height="11" x="3" y="11" rx="2" ry="2" />
                        <path d="M7 11V7a5 5 0 0 1 10 0v4" />
                    </svg>
                    认证安全
                </h3>
            </div>
            <div class="p-6 space-y-5">
                <!-- API Key -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1.5">
                        API 访问密钥
                        <span class="text-slate-400 font-normal ml-1">(可选)</span>
                    </label>
                    <div class="relative">
                        <input type="password" id="setting-api-key" name="apiKey" value="{{ settings.api_key }}"
                            class="w-full px-4 py-2.5 pr-12 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 bg-white transition-all text-sm font-mono"
                            placeholder="sk-xxxxxxxx（留空则禁用密钥验证）" autocomplete="off" />
                        <button type="button" onclick="togglePasswordVisibility('setting-api-key', this)"
                            class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" class="eye-icon">
                                <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z" />
                                <circle cx="12" cy="12" r="3" />
                            </svg>
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" class="eye-off-icon hidden">
                                <path d="m9.88 9.88a3 3 0 1 0 4.24 4.24" />
                                <path
                                    d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68" />
                                <path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61" />
                                <line x1="2" x2="22" y1="2" y2="22" />
                            </svg>
                        </button>
                    </div>
                    <p class="mt-1.5 text-xs text-slate-400">客户端需发送 <code
                            class="bg-slate-100 px-1 py-0.5 rounded">Authorization: Bearer &lt;key&gt;</code> 或 <code
                            class="bg-slate-100 px-1 py-0.5 rounded">x-api-key: &lt;key&gt;</code></p>
                </div>

                <!-- WebUI Password -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1.5">
                        WebUI 登录密码
                        <span class="text-red-500 ml-0.5">*</span>
                    </label>
                    <div class="relative">
                        <input type="password" id="setting-webui-password" name="webuiPassword"
                            value="{{ settings.webui_password }}"
                            class="w-full px-4 py-2.5 pr-12 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 bg-white transition-all text-sm font-mono"
                            placeholder="管理面板登录密码" autocomplete="off" />
                        <button type="button" onclick="togglePasswordVisibility('setting-webui-password', this)"
                            class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" class="eye-icon">
                                <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z" />
                                <circle cx="12" cy="12" r="3" />
                            </svg>
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" class="eye-off-icon hidden">
                                <path d="m9.88 9.88a3 3 0 1 0 4.24 4.24" />
                                <path
                                    d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68" />
                                <path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61" />
                                <line x1="2" x2="22" y1="2" y2="22" />
                            </svg>
                        </button>
                    </div>
                    <p class="mt-1.5 text-xs text-slate-400">用于登录此管理面板，请牢记此密码</p>
                </div>
            </div>
        </div>

        <!-- Debug Settings -->
        <div class="bg-white rounded-xl border border-slate-100 overflow-hidden">
            <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50">
                <h3 class="font-semibold text-slate-800 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" class="text-amber-500">
                        <path d="M12 20h9" />
                        <path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z" />
                    </svg>
                    调试配置
                </h3>
            </div>
            <div class="p-6 space-y-5">
                <!-- Debug Level -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1.5">
                        日志级别
                    </label>
                    <div class="flex gap-3">
                        <label class="flex-1 relative cursor-pointer">
                            <input type="radio" name="debug" value="off" class="peer sr-only" {% if
                                settings.debug=="off" || settings.debug.is_empty() %}checked{% endif %} />
                            <div
                                class="px-4 py-3 rounded-lg border border-slate-200 text-center transition-all peer-checked:border-blue-500 peer-checked:bg-blue-50 peer-checked:text-blue-700 hover:border-slate-300">
                                <div class="font-medium text-sm">关闭</div>
                                <div class="text-xs text-slate-400 mt-0.5">off</div>
                            </div>
                        </label>
                        <label class="flex-1 relative cursor-pointer">
                            <input type="radio" name="debug" value="low" class="peer sr-only" {% if
                                settings.debug=="low" %}checked{% endif %} />
                            <div
                                class="px-4 py-3 rounded-lg border border-slate-200 text-center transition-all peer-checked:border-blue-500 peer-checked:bg-blue-50 peer-checked:text-blue-700 hover:border-slate-300">
                                <div class="font-medium text-sm">基础</div>
                                <div class="text-xs text-slate-400 mt-0.5">low</div>
                            </div>
                        </label>
                        <label class="flex-1 relative cursor-pointer">
                            <input type="radio" name="debug" value="medium" class="peer sr-only" {% if
                                settings.debug=="medium" %}checked{% endif %} />
                            <div
                                class="px-4 py-3 rounded-lg border border-slate-200 text-center transition-all peer-checked:border-blue-500 peer-checked:bg-blue-50 peer-checked:text-blue-700 hover:border-slate-300">
                                <div class="font-medium text-sm">详细</div>
                                <div class="text-xs text-slate-400 mt-0.5">medium</div>
                            </div>
                        </label>
                        <label class="flex-1 relative cursor-pointer">
                            <input type="radio" name="debug" value="high" class="peer sr-only" {% if
                                settings.debug=="high" %}checked{% endif %} />
                            <div
                                class="px-4 py-3 rounded-lg border border-slate-200 text-center transition-all peer-checked:border-blue-500 peer-checked:bg-blue-50 peer-checked:text-blue-700 hover:border-slate-300">
                                <div class="font-medium text-sm">原始</div>
                                <div class="text-xs text-slate-400 mt-0.5">high</div>
                            </div>
                        </label>
                    </div>
                    <p class="mt-1.5 text-xs text-slate-400">设置服务端日志输出级别：<strong>medium</strong> 为“旧 high”（格式化输出），<strong>high</strong> 为完全原始流式输出</p>
                </div>
            </div>
        </div>

        <!-- API Settings -->
        <div class="bg-white rounded-xl border border-slate-100 overflow-hidden">
            <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50">
                <h3 class="font-semibold text-slate-800 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" class="text-emerald-500">
                        <path
                            d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" />
                        <path d="m3.3 7 8.7 5 8.7-5" />
                        <path d="M12 22V12" />
                    </svg>
                    API 配置
                </h3>
            </div>
            <div class="p-6 space-y-5">
                <!-- Backend Endpoint -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1.5">
                        后端请求地址
                    </label>
                    <div class="flex gap-3">
                        <label class="flex-1 relative cursor-pointer">
                            <input type="radio" name="endpointMode" value="production" class="peer sr-only" {% if
                                settings.endpoint_mode=="production" || settings.endpoint_mode.is_empty() %}checked{% endif %} />
                            <div
                                class="px-4 py-3 rounded-lg border border-slate-200 text-center transition-all peer-checked:border-emerald-500 peer-checked:bg-emerald-50 peer-checked:text-emerald-700 hover:border-slate-300">
                                <div class="font-medium text-sm">cloudcode-pa.googleapis.com</div>
                                <div class="text-xs text-slate-400 mt-0.5">默认</div>
                            </div>
                        </label>
                        <label class="flex-1 relative cursor-pointer">
                            <input type="radio" name="endpointMode" value="daily" class="peer sr-only" {% if
                                settings.endpoint_mode=="daily" %}checked{% endif %} />
                            <div
                                class="px-4 py-3 rounded-lg border border-slate-200 text-center transition-all peer-checked:border-emerald-500 peer-checked:bg-emerald-50 peer-checked:text-emerald-700 hover:border-slate-300">
                                <div class="font-medium text-sm">daily-cloudcode-pa.sandbox.googleapis.com</div>
                                <div class="text-xs text-slate-400 mt-0.5">Sandbox</div>
                            </div>
                        </label>
                    </div>
                    <p class="mt-1.5 text-xs text-slate-400">切换 Cloud Code API 的请求地址，仅影响后端请求。</p>
                </div>
                <!-- User Agent -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1.5">
                        User-Agent
                    </label>
                    <input type="text" id="setting-user-agent" name="userAgent" value="{{ settings.user_agent }}"
                        class="w-full px-4 py-2.5 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 bg-white transition-all text-sm font-mono"
                        placeholder="antigravity/1.11.17 windows/amd64" />
                    <p class="mt-1.5 text-xs text-slate-400">Cloud Code API 请求时使用的 User-Agent 头</p>
                </div>
            </div>
        </div>

        <!-- Gemini 3 Settings -->
        <div class="bg-white rounded-xl border border-slate-100 overflow-hidden">
            <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50">
                <h3 class="font-semibold text-slate-800 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" class="text-violet-500">
                        <path d="M12 2a10 10 0 1 0 10 10" />
                        <path d="M12 6v6l4 2" />
                        <path d="M22 2l-5 5" />
                    </svg>
                    Gemini 3 设置
                </h3>
            </div>
            <div class="p-6 space-y-5">
                <!-- Media Resolution -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1.5">
                        全局媒体分辨率
                    </label>
                    <div class="flex gap-3">
                        <label class="flex-1 relative cursor-pointer">
                            <input type="radio" name="gemini3MediaResolution" value="" class="peer sr-only" {% if
                                settings.gemini3_media_resolution.is_empty() %}checked{% endif %} />
                            <div
                                class="px-4 py-3 rounded-lg border border-slate-200 text-center transition-all peer-checked:border-violet-500 peer-checked:bg-violet-50 peer-checked:text-violet-700 hover:border-slate-300">
                                <div class="font-medium text-sm">默认</div>
                                <div class="text-xs text-slate-400 mt-0.5">自动 (auto)</div>
                            </div>
                        </label>
                        <label class="flex-1 relative cursor-pointer">
                            <input type="radio" name="gemini3MediaResolution" value="low" class="peer sr-only" {% if
                                settings.gemini3_media_resolution=="low" %}checked{% endif %} />
                            <div
                                class="px-4 py-3 rounded-lg border border-slate-200 text-center transition-all peer-checked:border-violet-500 peer-checked:bg-violet-50 peer-checked:text-violet-700 hover:border-slate-300">
                                <div class="font-medium text-sm">低</div>
                                <div class="text-xs text-slate-400 mt-0.5">low</div>
                            </div>
                        </label>
                        <label class="flex-1 relative cursor-pointer">
                            <input type="radio" name="gemini3MediaResolution" value="medium" class="peer sr-only" {% if
                                settings.gemini3_media_resolution=="medium" %}checked{% endif %} />
                            <div
                                class="px-4 py-3 rounded-lg border border-slate-200 text-center transition-all peer-checked:border-violet-500 peer-checked:bg-violet-50 peer-checked:text-violet-700 hover:border-slate-300">
                                <div class="font-medium text-sm">中</div>
                                <div class="text-xs text-slate-400 mt-0.5">medium</div>
                            </div>
                        </label>
                        <label class="flex-1 relative cursor-pointer">
                            <input type="radio" name="gemini3MediaResolution" value="high" class="peer sr-only" {% if
                                settings.gemini3_media_resolution=="high" %}checked{% endif %} />
                            <div
                                class="px-4 py-3 rounded-lg border border-slate-200 text-center transition-all peer-checked:border-violet-500 peer-checked:bg-violet-50 peer-checked:text-violet-700 hover:border-slate-300">
                                <div class="font-medium text-sm">高</div>
                                <div class="text-xs text-slate-400 mt-0.5">high</div>
                            </div>
                        </label>
                    </div>
                    <p class="mt-1.5 text-xs text-slate-400">仅对 <strong>Gemini 3</strong> 生效：控制图片/视频/PDF
                        的视觉处理分辨率。分辨率越高通常细节更丰富，但 token 消耗更高。</p>
                </div>
            </div>
        </div>

        <!-- Cache Settings -->
        <div class="bg-white rounded-xl border border-slate-100 overflow-hidden">
            <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50">
                <h3 class="font-semibold text-slate-800 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" class="text-amber-500">
                        <path d="M12 2v6" />
                        <path d="M12 18v4" />
                        <path d="M4.93 4.93l4.24 4.24" />
                        <path d="M14.83 14.83l4.24 4.24" />
                        <path d="M2 12h6" />
                        <path d="M16 12h6" />
                        <path d="M4.93 19.07l4.24-4.24" />
                        <path d="M14.83 9.17l4.24-4.24" />
                    </svg>
                    缓存设置
                </h3>
            </div>
            <div class="p-6 space-y-5">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1.5">
                        签名缓存保留天数
                    </label>
                    <input type="number" id="setting-cache-retention-days" name="cacheRetentionDays" min="1" step="1"
                        value="{{ settings.cache_retention_days }}"
                        class="w-full px-4 py-2.5 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 bg-white transition-all text-sm font-mono"
                        placeholder="7" />
                    <p class="mt-1.5 text-xs text-slate-400">
                        仅清理 <code class="bg-slate-100 px-1 py-0.5 rounded">data/signatures</code> 下的
                        <code class="bg-slate-100 px-1 py-0.5 rounded">.idx</code>/<code
                            class="bg-slate-100 px-1 py-0.5 rounded">.jsonl</code>，并且不会删除今天与昨天的文件。
                    </p>
                </div>

                <div class="flex items-center justify-end">
                    <button type="button" id="cache-cleanup-btn"
                        class="px-5 py-2.5 text-sm font-medium text-amber-700 bg-amber-50 border border-amber-200 rounded-lg hover:bg-amber-100 transition-colors">
                        立即清理
                    </button>
                </div>
            </div>
        </div>

        <!-- Submit Button -->
        <div class="flex items-center justify-end gap-3 pt-2">
            <button type="button" onclick="resetSettingsForm()"
                class="px-5 py-2.5 text-sm font-medium text-slate-600 bg-white border border-slate-200 rounded-lg hover:bg-slate-50 transition-colors">
                重置
            </button>
            <button type="submit" id="save-settings-btn"
                class="px-6 py-2.5 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" class="save-icon">
                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" />
                    <polyline points="17 21 17 13 7 13 7 21" />
                    <polyline points="7 3 7 8 15 8" />
                </svg>
                <span>保存设置</span>
            </button>
        </div>
    </form>

    <script>
        (() => {
            const form = document.getElementById('settings-form');
            const saveBtn = document.getElementById('save-settings-btn');

            const toast = (message, type) => {
                document.body.dispatchEvent(new CustomEvent('showMessage', { detail: { message, type } }));
            };

            // Toggle password visibility
            window.togglePasswordVisibility = (inputId, btn) => {
                const input = document.getElementById(inputId);
                const eyeIcon = btn.querySelector('.eye-icon');
                const eyeOffIcon = btn.querySelector('.eye-off-icon');

                if (input.type === 'password') {
                    input.type = 'text';
                    eyeIcon.classList.add('hidden');
                    eyeOffIcon.classList.remove('hidden');
                } else {
                    input.type = 'password';
                    eyeIcon.classList.remove('hidden');
                    eyeOffIcon.classList.add('hidden');
                }
            };

            // Reset form to initial values
            window.resetSettingsForm = async () => {
                try {
                    const resp = await fetch('/manager/api/settings', { credentials: 'same-origin' });
                    const data = await resp.json();
                    if (resp.ok && data) {
                        document.getElementById('setting-api-key').value = data.apiKey || '';
                        document.getElementById('setting-webui-password').value = data.webuiPassword || '';
                        document.getElementById('setting-user-agent').value = data.userAgent || '';
                        const endpointRadios = document.querySelectorAll('input[name="endpointMode"]');
                        endpointRadios.forEach(r => {
                            r.checked = r.value === (data.endpointMode || 'production');
                        });
                        const debugRadios = document.querySelectorAll('input[name="debug"]');
                        debugRadios.forEach(r => {
                            r.checked = r.value === (data.debug || 'off');
                        });
                        const mrRadios = document.querySelectorAll('input[name="gemini3MediaResolution"]');
                        mrRadios.forEach(r => {
                            r.checked = r.value === (data.gemini3MediaResolution || '');
                        });
                        document.getElementById('setting-cache-retention-days').value = data.cacheRetentionDays || 7;
                        toast('设置已重置', 'success');
                    }
                } catch (e) {
                    toast('重置失败: ' + (e?.message || '未知错误'), 'error');
                }
            };

            // Cache cleanup
            const cleanupBtn = document.getElementById('cache-cleanup-btn');
            cleanupBtn?.addEventListener('click', async () => {
                cleanupBtn.disabled = true;
                cleanupBtn.textContent = '清理中...';
                try {
                    const resp = await fetch('/manager/api/cache/cleanup', { method: 'POST', credentials: 'same-origin' });
                    const data = await resp.json().catch(() => ({}));

                    if (!resp.ok || !data?.success) {
                        throw new Error(data?.error || '清理失败');
                    }
                    toast(`清理完成：已删除 ${data.deleted || 0} 个文件`, 'success');
                } catch (e) {
                    toast(e?.message || '清理失败', 'error');
                } finally {
                    cleanupBtn.disabled = false;
                    cleanupBtn.textContent = '立即清理';
                }
            });

            // Submit form
            form?.addEventListener('submit', async (e) => {
                e.preventDefault();

                const apiKey = document.getElementById('setting-api-key')?.value?.trim() || '';
                const webuiPassword = document.getElementById('setting-webui-password')?.value?.trim() || '';
                const userAgent = document.getElementById('setting-user-agent')?.value?.trim() || '';
                const endpointRadio = document.querySelector('input[name="endpointMode"]:checked');
                const endpointMode = endpointRadio?.value || 'production';
                const debugRadio = document.querySelector('input[name="debug"]:checked');
                const debug = debugRadio?.value || 'off';
                const mrRadio = document.querySelector('input[name="gemini3MediaResolution"]:checked');
                const gemini3MediaResolution = mrRadio?.value || '';
                const retentionDaysStr = document.getElementById('setting-cache-retention-days')?.value?.trim() || '7';
                const cacheRetentionDays = parseInt(retentionDaysStr, 10);

                if (!webuiPassword) {
                    toast('WebUI 登录密码不能为空', 'error');
                    return;
                }
                if (!Number.isFinite(cacheRetentionDays) || cacheRetentionDays < 1) {
                    toast('缓存保留天数必须大于 0', 'error');
                    return;
                }

                saveBtn.disabled = true;
                saveBtn.innerHTML = '<svg class="animate-spin" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg><span>保存中...</span>';

                try {
                    const resp = await fetch('/manager/api/settings', {
                        method: 'POST',
                        credentials: 'same-origin',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ apiKey, webuiPassword, debug, userAgent, gemini3MediaResolution, endpointMode, cacheRetentionDays })
                    });
                    const data = await resp.json().catch(() => ({}));

                    if (!resp.ok) {
                        throw new Error(data.error || '保存失败');
                    }

                    toast('设置已保存并生效', 'success');
                } catch (e) {
                    toast(e?.message || '保存失败', 'error');
                } finally {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="save-icon"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg><span>保存设置</span>';
                }
            });
        })();
    </script>
</div>
